version: '3.7'

services:
  mongodb:
    image: mongo:latest
    environment:
      - MONGO_INITDB_ROOT_USERNAME=leonardo
      - MONGO_INITDB_ROOT_PASSWORD_FILE=/run/secrets/mongo_pass
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s
    secrets:
      - mongo_pass
    volumes:
      - mongodb_data:/data/db

  frontend:
    build:
      context: ./leonardo
      target: PROD
    volumes:
      - ./leonardo/:/src
    depends_on:
      - mongodb

  backend:
    build:
      context: ./flask
      target: PROD
    stop_signal: SIGINT
    environment:
      - MONGO_USER=leonardo
      - MONGO_PASSWORD_FILE=/run/secrets/mongo_pass
      - DEBUG=false
      - FLASK_PORT=1447
    volumes:
      - ./flask/src:/src
    depends_on:
      mongodb:
        condition: service_healthy
    secrets:
      - mongo_pass

  web:
    image: nginx
    environment:
      - DOMAIN=leonardo.racherom.wtf
      - BACKEND_ADDR=backend:1447
    volumes:
      - www:/var/www/leonardo
      - ./nginx/nginx.conf:/tmp/nginx.conf
    command: /bin/bash -c "envsubst < /tmp/nginx.conf > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
    ports:
      - 80:80
      - 443:443
    depends_on:
      certbot_init:
        condition: service_completed_successfully
      frontend:
        condition: service_completed_successfully
      backend:
        condition: service_healthy

  certbot_init:
    image: certbot/certbot
    restart: no
    volumes:
      - ssl_certificates:/etc/letsencrypt
    ports:
      - 80:80
    command: certonly --standalone -n -m admin@racherom.wtf -d leonardo.racherom.wtf --agree-tos

  certbot:
    image: certbot/certbot
    restart: unless-stopped
    volumes:
      - ssl_certificates:/etc/letsencrypt
      - www_challenge:/var/www/certbot
    depends_on:
      - web
    environment:
      - DOMAIN=leonardo.racherom.wtf
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
  www:
  www_challenge:
  mongodb_data:
  ssl_certificates:

networks:
  leonardo:

secrets:
  secret_key:
    file: secrets/secret_key
  mongo_pass:
    file: secrets/mongodb_password
